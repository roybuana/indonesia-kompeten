<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <title>Indonesia Kompeten</title>

        <link rel="stylesheet" type="text/css" href="themes/metro/easyui.css">
        <link rel="stylesheet" type="text/css" href="themes/mobile.css">
        <link rel="stylesheet" type="text/css" href="themes/icon.css">

        <script type="text/javascript" src="jquery.min.js"></script>

        <script type="text/javascript">
            var base_url = "http://" + location.host + "/lsp_mobile/";
            var remote_url = "http://" + location.host + "/rest/";
            $.urlParam = function (name) {
                var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
                return results[1] || 0;
            }

            var kode_lsp = $.urlParam('kode_lsp');
        </script>

        <style>
            .asterisk{
                color:red;
                font-weight: bold;
            }
            .buktitam h3{
                text-decoration: underline;
            }
            .box{
                padding: 10px;
                border-bottom: 1px solid #ccc;
            }
        </style>

    </head>
    <body>

        <!-- Step 1 //-->
        <div class="easyui-navpanel">
            <header>
                <div class="m-toolbar">
                    <div class="m-left">
                        <a href="#" class="easyui-linkbutton m-back" data-options="plain:true,outline:true,back:true">Back</a>
                    </div>
                    <div class="m-title">APL - 01</div>
                </div>
            </header>


            <!-- FORM STEP 1 //-->
            <div class="content_mobile" style="padding:0 20px">

                <h2>REGISTRASI UJI KOMPETENSI</h2>

                <form id="ff">
                    <div style="margin-bottom:10px">
                        <input id="cc" name="skema" label='Skema:' style="width:100%;">
                    </div>

                    <div style="margin-bottom:10px">
                        <input id="no_identitas" class="easyui-textbox" name="no_identitas" label="No. Identitas :" prompt="No. Identitas" style="width:100%" />
                    </div>

                    <div style="margin-bottom:10px">
                        <input id="nama" class="easyui-textbox" name="nama" label="Nama Lengkap:" prompt="Full name" style="width:100%" />
                    </div>

                    <div style="margin-bottom:10px">
                        <input id="organisasi" class="easyui-textbox" name="organisasi" label="Organisasi:" prompt="Organisasi" style="width:100%" />
                    </div>

                    <div style="margin-bottom:10px">
                        <input id="tempat_lahir" class="easyui-textbox" name="tempat_lahir" label="Tempat Lahir :" prompt="Tempat Lahir" style="width:100%" />
                    </div>

                    <div style="margin-bottom:10px">
                        <input class="easyui-datebox" name="tgl_lahir" label="Tgl Lahir:" prompt="Birthday" data-options="editable:false,panelWidth:220,panelHeight:240,iconWidth:30" style="width:100%" />
                    </div>

                    <div style="margin-bottom:10px">
                        <input class="easyui-textbox" label="No HP:" name='no_telp' prompt="Number" style="width:100%">
                    </div>

                    <div style="margin-bottom:10px">
                        <input class="easyui-textbox" label="Email:" name='email' prompt="Email" style="width:100%">
                    </div>

                    <div style="margin-bottom:10px">
                        <input id="jadwal" name="jadwal" value="Jadwal Uji" label='Jadwal Uji:' style="width:100%;">
                    </div>

                    <div style="text-align:center;margin-top:30px">
                        <a id="tombolRegister" href="javascript:void(0)">Step 2 >></a>
                        <!--#p2//-->
                    </div>

                </form>
            </div>

        </div>

        <!-- Step 2 //-->
        <div id="p2" class="easyui-navpanel">
            <header>
                <div class="m-toolbar">
                    <div class="m-left">
                        <a href="#" class="easyui-linkbutton m-back" data-options="plain:true,outline:true,back:true">Back</a>
                    </div>
                    <div class="m-title">Upload Dokumen Bukti</div>
                </div>
            </header>

            <form id="ff2" enctype="multipart/form-data">
                <div style="padding: 0 10px;margin-top: 10px;">
                    <div style="margin-bottom:10px" id="dtfoto">
                        <label>Foto <span class="asterisk">(*)</span></label>
                        <input id="foto" name="foto" prompt="Foto" style="width:100%">
                    </div>

                    <div style="margin-bottom:10px" id="dtktp">
                        <label>KTP <span class="asterisk">(*)</span></label>
                        <input id="ktp" name="ktp" prompt="KTP" style="width:100%" />
                    </div>

                    <div style="margin-bottom:10px" id="dtijazah">
                        <label>Ijazah <span class="asterisk">(*)</span></label>
                        <input id="ijazah" name="ijazah" prompt="Ijazah" style="width:100%" />
                    </div>
                </div>

                <div style="margin-bottom: 20px;"></div>
                <div style="padding: 0 10px;margin-top: 10px;" class="buktitam">
                    <h3>Upload Bukti Tambahan / Lainnya</h3>
                    <div style="margin-bottom:10px">
                        <label>Nama Dokumen <span class="asterisk">(*)</span></label>
                        <input id="nama_dokumen" class="easyui-textbox" name="nama_dokumen" prompt="Nama Dokumen" style="width:100%" />
                    </div>
                    <div style="margin-bottom:10px" id="dtdokumen">
                        <input id="dokumen" name="dokumen" prompt="Dokumen" style="width:100%" />
                    </div>
                </div>

                <div style="padding: 0 10px;margin-top: 10px;">
                    <div style="text-align:center;margin-top:30px">
                        <a id="step2" href="javascript:void(0)">Step 3 >></a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Step 3 //-->
        <div id="p3" class="easyui-navpanel">
            <form id="ff3" enctype="multipart/form-data">
                <header>
                    <div class="m-toolbar">
                        <div class="m-left">
                            <a href="#" class="easyui-linkbutton m-back" id="p3Back" data-options="plain:true,outline:true,back:true">Back</a>
                        </div>
                        <div class="m-title">Asesmen Mandiri</div>
                    </div>
                </header>


                <div style="padding: 0 10px;margin-top: 10px;" id="boxAsesmen">

                    <!--
                    <div class="box">
                        Kode Unit<br/>
                        Judul Unit<br/>
                        <input class="easyui-switchbutton" data-options="onText:'K',offText:'BK'"/><br/>
                        Bukti Pendukung
                    </div>
                    //-->

                </div>


                <div style="padding: 0 10px;margin-top: 10px;"></div>

                <div style="padding: 0 10px;margin-top: 10px;">
                    <div style="text-align:center;margin-top:30px">
                        <a id="step3" href="#p4">Selesai & Kirim</a>
                    </div>
                </div>

                <footer>
                    <div style="clear: both;margin-bottom: 10px;"></div>
                </footer>
            </form>
        </div>

        <div id="dlg">
            The dialog content.
        </div>

        <script type="text/javascript" src="jquery.easyui.min.js"></script>
        <script type="text/javascript" src="jquery.easyui.mobile.js"></script>

        <script type="text/javascript">
            $(document).ready(function () {

                $('#dlg').dialog({
                    title: 'Detail Unit Kompetensi',
                    width: 270,
                    height: 200,
                    closed: true,
                    cache: false,
                    collapsible: true,
                    maximizable: true,
                    modal: true,
                    buttons: [{
                            text: 'Close',
                            handler: function () {
                                $('#dlg').dialog('close');
                            }
                        }]
                });

                $("#tombolRegister").linkbutton({
                    width: '100%',
                    heigth: '40px',
                    size: 'large',
                    onClick: function (data) {
                        var dtform = $("#ff").serializeArray();
                        var jmlIsi = dtform.length;
                        var no = 0;
                        $.each(dtform, function (key, dt) {
                            if (dt.value !== "") {
                                no++;
                            }
                        });
                        //$("#tombolRegister").attr('href', '#p2');

                        if (no == parseInt(jmlIsi)) {
                            //window.location = "#p2";
                            $("#tombolRegister").attr('href', '#p2');
                        } else {
                            $.messager.alert("Pesan", "Data harus diisi semua !");
                        }

                        return false;
                    }
                });
                $("#step2").linkbutton({
                    width: '100%',
                    heigth: '40px',
                    size: 'large',
                    onClick: function (data) {
                        //$("#step2").hide();
                        var dtform = $("#ff").serializeArray();
                        var idskema = dtform[0].value;
                        $("#step2").attr('href', '#p3');
                        getUnitskema(idskema);
                    }
                });

                function getUnitskema(idskema) {
                    $.ajax({
                        url: remote_url + 'index.php/unit_skema/index/' + kode_lsp,
                        data: {id: idskema},
                        success: function (hsl) {
                            var hasil = JSON.parse(hsl);

                            var itemOp = [];
                            $.each($(".uploadData"), function (key, dt) {
                                itemOp.push({'id': dt.value, 'text': dt.value});
                            });
                            //console.log(JSON.stringify(itemOp));

                            $("#boxAsesmen").empty();

                            $.each(hasil, function (key, dt) {
                                //console.log(dt);
                                var item = '<div class="box">';
                                item += dt.id_unit_kompetensi + '<br/>';
                                item += dt.unit_kompetensi + '<br/>';
                                item += '<input class="bk">&nbsp;';
                                item += '<select name="bukti_pendukung[]" class="bukti_pendukung" style="width:150px;"></select><br/>';
                                item += '<a href="javascript:void(0)" data-url="' + remote_url + 'index.php/unit_skema/detail_unit/' + kode_lsp + '/' + dt.id_unit + '" class="btnDetail">Detail</a>';
                                item += '</div>';
                                $("#boxAsesmen").append(item);
                                $('.bk').switchbutton({
                                    onText: 'K',
                                    offText: 'BK'
                                });
                                $(".bukti_pendukung").combobox({
                                    data: itemOp,
                                    valueField: 'id',
                                    textField: 'text'
                                });
                                $('.btnDetail').linkbutton({
                                    iconCls: 'icon-search',
                                    onClick: function () {
                                        var urlTarget = $(this).attr('data-url');
                                        console.log(urlTarget);
                                        $('#dlg').dialog('refresh', urlTarget);
                                        $('#dlg').dialog('open');
                                    }
                                });
                            });
                        }
                    });
                }

                $("#step3").linkbutton({
                    width: '100%',
                    heigth: '40px',
                    size: 'large',
                    onClick: function (data) {
                        var dtform = $("#ff").serialize();
                        var dtform2 = $("#ff2").serialize();
                        var dtform3 = $("#ff3").serialize();

                        var dt = {form1: dtform, form2: dtform2, form3: dtform3, kodelsp: kode_lsp}

                        $.ajax({
                            type: 'post',
                            url: remote_url + 'index.php/uji/simpan',
                            data: dt,
                            success: function (hsl) {
                                hsl = JSON.parse(hsl);
                                //console.log(hsl);
                                if (hsl.success === true) {
                                    $.messager.alert("Sukses", hsl.pesan);
                                    window.location = base_url + "main.html?kode_lsp=" + kode_lsp;
                                } else {
                                    $.messager.alert("Gagal", hsl.pesan);
                                }
                                return false;
                            }
                        });

                    }
                });
                $('#cc').combobox({
                    url: remote_url + 'index.php/combo_skema/' + kode_lsp,
                    valueField: 'id',
                    textField: 'text',
                    method: 'get'
                });
                $('#jadwal').combobox({
                    url: remote_url + 'index.php/jadwal/combo?kode_lsp=' + kode_lsp,
                    valueField: 'id',
                    textField: 'text',
                    method: 'get'
                });
                $("#nama_dokumen").combobox({
                    data: [{name: '', value: '- Nama Dokumen -'}, {name: 'foto', value: 'Foto'}, {name: 'ktp', value: 'KTP'}, {name: 'ijazah', value: 'Ijazah'}, {name: 'skkd', value: 'Surat Keterangan Keaslian Dok.'}, {name: 'cp', value: 'Contoh / Report Pekerjaan (CP)'}, {name: 'surat_pelatihan', value: 'Sertifikat Pelatihan (SK)'}, {name: 'surat_referensi', value: 'Surat Referensi dari Perusahaan'}, {name: 'job_description', value: 'Job Description (JD)'}, {name: 'demonstrasi_pekerjaan', value: 'Demonstrasi Pekerjaan (De)'}, {name: 'wawancara_supervisor', value: 'Wawancara dg. Supervisor, teman atau klien'}, {name: 'pengalaman_industri', value: 'Pengalaman Industri (Pe)'}, {name: 'bukti_relevan', value: 'Bukti-Bukti Lain yang Masih Relevan / CV'}, {name: 'sertifikat_expired', value: 'Sertifikat Expired'}],
                    valueField: 'name',
                    textField: 'value'
                });
                // Upload Dokumen
                $('#foto').filebox({
                    onChange: function (data) {
                        var urlTarget = remote_url + "index.php/uji/upload/" + kode_lsp + "/foto";
                        //$.messager.alert("Title", urlTarget);
                        var f = $("input[name=foto]");
                        var listFiles = f[0].files;
                        var formData = new FormData();
                        formData.append('file', listFiles[0]);
                        $.ajax({
                            url: urlTarget,
                            type: 'POST',
                            data: formData,
                            processData: false, // tell jQuery not to process the data
                            contentType: false, // tell jQuery not to set contentType
                            success: function (data) {
                                data = JSON.parse(data);
                                var txt = "<input name='file_data[]' class='easyui-textbox uploadData' value='" + data.upload_data.file_name + "' readonly />";
                                $("#dtfoto").append(txt);
                            }
                        });
                    }
                });
                $('#ktp').filebox({
                    onChange: function (data) {
                        var urlTarget = remote_url + "index.php/uji/upload/" + kode_lsp + "/ktp";
                        var f = $("input[name=ktp]");
                        var listFiles = f[0].files;
                        var formData = new FormData();
                        formData.append('file', listFiles[0]);
                        $.ajax({
                            url: urlTarget,
                            type: 'POST',
                            data: formData,
                            processData: false, // tell jQuery not to process the data
                            contentType: false, // tell jQuery not to set contentType
                            success: function (data) {
                                data = JSON.parse(data);
                                var txt = "<input name='file_data[]' class='easyui-textbox uploadData' value='" + data.upload_data.file_name + "' readonly />";
                                $("#dtktp").append(txt);
                            }
                        });
                    }
                });
                $('#ijazah').filebox({
                    onChange: function (data) {
                        var urlTarget = remote_url + "index.php/uji/upload/" + kode_lsp + "/ijazah";
                        var f = $("input[name=ijazah]");
                        var listFiles = f[0].files;
                        var formData = new FormData();
                        formData.append('file', listFiles[0]);
                        $.ajax({
                            url: urlTarget,
                            type: 'POST',
                            data: formData,
                            processData: false, // tell jQuery not to process the data
                            contentType: false, // tell jQuery not to set contentType
                            success: function (data) {
                                data = JSON.parse(data);
                                var txt = "<input name='file_data[]' class='easyui-textbox uploadData' value='" + data.upload_data.file_name + "' readonly />";
                                $("#dtijazah").append(txt);
                            }
                        });
                    }
                });
                $('#dokumen').filebox({
                    onChange: function (data) {
                        var nama_dokumen = $("#nama_dokumen").val();
                        //$.messager.alert("Title", nama_dokumen);

                        var urlTarget = remote_url + "index.php/uji/upload/" + kode_lsp + "/" + nama_dokumen;
                        var f = $("input[name=dokumen]");
                        var listFiles = f[0].files;
                        var formData = new FormData();
                        formData.append('file', listFiles[0]);
                        $.ajax({
                            url: urlTarget,
                            type: 'POST',
                            data: formData,
                            processData: false, // tell jQuery not to process the data
                            contentType: false, // tell jQuery not to set contentType
                            success: function (data) {
                                data = JSON.parse(data);
                                var txt = "<input name='file_data[]' class='easyui-textbox uploadData' value='" + data.upload_data.file_name + "' readonly />";
                                $("#dtdokumen").append(txt);
                            }
                        });
                    }
                });
            });

        </script>


    </body>
</html>